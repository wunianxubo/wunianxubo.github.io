<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Wunian"><title>谈谈分布式事务 | Wunian's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">谈谈分布式事务</h1><a id="logo" href="/.">Wunian's Blog</a><p class="description">清风徐来，水波不兴</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">谈谈分布式事务</h1><div class="post-meta">Apr 16, 2018<span> | </span><span class="category"><a href="/categories/分布式系统/">分布式系统</a></span></div><div class="post-content"><h2 id="什么是分布式事务"><a href="#什么是分布式事务" class="headerlink" title="什么是分布式事务"></a>什么是分布式事务</h2><p>一个事务由多个不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要确保这些小的操作要么全部成功，要么全部失败。从本质上说，分布式事务是为了保证不同数据库之间的一致性。分布式事务的应用场景主要是在支付和在线下单，支付涉及到扣款和加钱，而在线下单则涉及到扣库存和更新账单，需要分布式事务来保证一致性。    </p>
<a id="more"></a>
<h2 id="分布式事务产生的原因"><a href="#分布式事务产生的原因" class="headerlink" title="分布式事务产生的原因"></a>分布式事务产生的原因</h2><h3 id="数据库的分库分表"><a href="#数据库的分库分表" class="headerlink" title="数据库的分库分表"></a>数据库的分库分表</h3><p>分库分表后，原来的一个数据库分为了多个数据库，如果一个操作既要更新库01，又要更新库02，而且要保证数据的一致性，那么就需要用到分布式事务。  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/shiwu1.png" alt="image">  </p>
<h3 id="应用SOA化"><a href="#应用SOA化" class="headerlink" title="应用SOA化"></a>应用SOA化</h3><p>即业务的服务化。以前单机支撑了整个电商网站，现在对整个网站进行拆解，分离出了订单中心，用户中心，库存中心等，对于每个中心有专门的数据库进行信息的存储。如果同时涉及到对订单和库存的操作，那么为了保证数据的一致性，需要用到分布式事务。  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/shiwu2.png" alt="image">  </p>
<h2 id="事务的ACID特性"><a href="#事务的ACID特性" class="headerlink" title="事务的ACID特性"></a>事务的ACID特性</h2><ul>
<li>原子性<br>在整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态。对于事务在执行中发生错误，所有的操作都会被回滚，整个事务就像从没被执行过一样。</li>
<li>一致性<br>事务的执行必须保证系统的一致性，就拿转账为例，A有500元，B有300元，如果在一个事务里A成功转给B50元，那么不管并发多少，不管发生什么，只要事务执行成功了，那么最后A账户一定是450元，B账户一定是350元。</li>
<li>隔离性<br>所谓的隔离性就是说，事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知。</li>
<li>持久性<br>持久性，就是说一单事务完成了，那么事务对数据所做的变更就完全保存在了数据库中，即使发生停电，系统宕机也是如此。  </li>
</ul>
<h2 id="一致性理论"><a href="#一致性理论" class="headerlink" title="一致性理论"></a>一致性理论</h2><h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p>在分布式系统中，一致性（Consistency）、可用性（Availabilty）和分区容忍性（Partition Tolerance）三个要素最多只能同时满足两个，不可兼得，而对于分布式系统，分区容忍性是不可或缺的。  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/cap.png" alt="image"></p>
<ul>
<li>一致性：分布式环境下多个节点的数据是否强一致。  </li>
<li>可用性：分布式服务能一直保证可用状态。当用户发出一个请求后，服务能在有限时间内返回结果。  </li>
<li>分区容忍性：特指对网络分区的容忍性。  </li>
</ul>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><ul>
<li>基本可用（Basically Available）：指分布式系统在出现故障时，允许损失部分的可用性来保证核心可用。</li>
<li>软状态（Soft State）：指允许分布式系统存在中间状态，该中间状态不会影响到系统的整体可用性。</li>
<li>最终一致性（Eventual Consistency）：指分布式系统中的所有副本数据经过一定时间后，最终能够达到一致的状态</li>
</ul>
<h2 id="一致性模型"><a href="#一致性模型" class="headerlink" title="一致性模型"></a>一致性模型</h2><ul>
<li>强一致性：数据更新成功后，任意时刻所有副本中的数据都是一致的，一般采用同步的方式实现。</li>
<li>弱一致性：数据更新成功后，系统不承诺立即可以读到最新写入的值，也不承诺具体多久之后可以读到。</li>
<li>最终一致性：弱一致性的一种形式，数据更新成功后，系统不承诺立即可以返回最新写入的值，但是保证最终会返回上一次更新操作的值。</li>
</ul>
<h2 id="常见的分布式事务解决方案"><a href="#常见的分布式事务解决方案" class="headerlink" title="常见的分布式事务解决方案"></a>常见的分布式事务解决方案</h2><h3 id="1、基于XA协议的两阶段提交（2PC）"><a href="#1、基于XA协议的两阶段提交（2PC）" class="headerlink" title="1、基于XA协议的两阶段提交（2PC）"></a>1、基于XA协议的两阶段提交（2PC）</h3><p>XA协议分为两部分：事务管理器和本地资源管理器，本地资源管理器主要由数据库实现，而事务管理器作为全局的调度者，负责各个本地资源的提交和回滚。  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/2pc%20tb.jpg" alt="image">  </p>
<p>这种方式实现难度不算高，比较适合传统的单体应用，在同一个方法中存在跨库操作的情况，能保证强一致性。但对性能的影响比较大，不适合高并发和高性能要求的场景。  </p>
<h3 id="2、消息事务-最终一致性"><a href="#2、消息事务-最终一致性" class="headerlink" title="2、消息事务 - 最终一致性"></a>2、消息事务 - 最终一致性</h3><p>消息事务是基于消息中间件的两阶段提交，将本地事务和发消息放在了一个分布式事务里，保证要么本地操作成功并且对外发消息成功，要么两个操作都失败。  </p>
<p>基于消息中间件的两阶段提交往往用在高并发场景下，将一个分布式事务拆分成一个消息事务（A系统的本地操作+发消息）+B系统的本地操作。其中B系统的操作由消息驱动，只要消息事务成功，那么A操作一定成功，消息也一定发出来了，之后B会受到消息去执行本地操作，如果本地操作失败，消息会重投，知道B操作成功，这样就变相的完成了A与B的分布式事务。  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/message%20tx.png" alt="image">  </p>
<h3 id="3、事务补偿型（TCC事务）"><a href="#3、事务补偿型（TCC事务）" class="headerlink" title="3、事务补偿型（TCC事务）"></a>3、事务补偿型（TCC事务）</h3><p>在一个长事务中，由两台服务器一起参与，服务器A发起事务，服务器B参与事务。如果服务器A的事务执行顺利，那么事务A先行提交，如果事务B也执行顺利，则事务B也提交，整个事务完成。如果事务B执行失败，事务B本身回滚，这时事务A已经被提交，所以需要执行一个补偿操作，将已经提交的事务A执行的操作作反操作，恢复到未执行事务A的状态。  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/tcc.jpg" alt="image">  </p>
<p><img src="http://osrmzp0jr.bkt.clouddn.com/tcc2.jpg" alt="image">  </p>
<p>参考文章：<br>分布式事务的典型处理方式 <a href="https://blog.csdn.net/mine_song/article/details/64118963" target="_blank" rel="external">https://blog.csdn.net/mine_song/article/details/64118963</a><br>大规模SOA系统中的分布事务处理  <a href="https://wenku.baidu.com/view/be946bec0975f46527d3e104.html" target="_blank" rel="external">https://wenku.baidu.com/view/be946bec0975f46527d3e104.html</a></p>
</div><div class="tags"><a href="/tags/大型网站技术架构/">大型网站技术架构</a><a href="/tags/分布式/">分布式</a></div><div class="post-nav"><a class="pre" href="/2018/04/20/Spring源码解析之IOC容器（一）/">Spring源码解析之IOC容器（一）</a><a class="next" href="/2018/04/12/浅谈分库分表/">浅谈分库分表</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring源码解析/">Spring源码解析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java并发/">java并发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式系统/">分布式系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/剑指offer/">剑指offer</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大型网站技术架构核心原理/">大型网站技术架构核心原理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/深入理解Java虚拟机/">深入理解Java虚拟机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/算法，剑指offer/" style="font-size: 15px;">算法，剑指offer</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/java并发/" style="font-size: 15px;">java并发</a> <a href="/tags/java基础/" style="font-size: 15px;">java基础</a> <a href="/tags/java，java基础/" style="font-size: 15px;">java，java基础</a> <a href="/tags/java虚拟机/" style="font-size: 15px;">java虚拟机</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/操作系统/" style="font-size: 15px;">操作系统</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a> <a href="/tags/大型网站技术架构/" style="font-size: 15px;">大型网站技术架构</a> <a href="/tags/分布式系统/" style="font-size: 15px;">分布式系统</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/07/14/Spring源码解析之AOP设计与实现/">Spring源码解析之AOP设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/25/负载均衡那些事/">负载均衡那些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/16/Netty之EventLoop与线程模型 /">Netty之EventLoop与线程模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/15/Netty 之组件与设计 /">Netty之组件与设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/14/Netty之构建Netty应用程序/">Netty之构建Netty应用程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/13/Netty剖析之核心组件/">Netty剖析之核心组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/11/Spring源码解析之IOC容器（二）/">Spring源码解析之IOC容器（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/Spring源码解析之IOC容器（一）/">Spring源码解析之IOC容器（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/谈谈分布式事务/">谈谈分布式事务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/浅谈分库分表/">浅谈分库分表</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://coolshell.cn/" title="陈皓" target="_blank">陈皓</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Wunian's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>